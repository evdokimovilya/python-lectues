 В этом туториале мы разместим djagno приложение на сервере так, чтобы оно было доступно по доменному имени, как обычный сайт. 

Общая схема работы приложения в продакшн среде 

![фвыа](http://images.na4u.ru/static/deploy/1.png)
# 1. Cхема работы приложения при деплое
### 1. Nginx — "внешний фронт"

**Основная роль:** принимать HTTP-запросы от клиентов и решать, что с ними делать.

**Задачи:**
- Слушает порт 80/443 (HTTP/HTTPS);
- Обрабатывает статику (CSS, JS, изображения);
- Проксирует динамические запросы к backend’у (uWSGI, Gunicorn и т.д.);
- Делает SSL-терминацию (шифрование HTTPS);
- Может кэшировать ответы, сжимать gzip, ставить rate-limit и т.д.
- По адресу запроса определяет, какое приложение запускать

### 2. uWSGI — "переводчик" между Nginx и Python/Django

**Основная роль:** запускать и обслуживать само Django-приложение.

Django — это просто Python-код, он не умеет сам принимать HTTP-запросы.  
uWSGI делает это за него.

uWSGI можно запускать с различными параметрами, настраивать количество воркеров - процессов, которые могут работать одновременно и обрабатывать запросы. 


# 2. Подготовка приложения

### Создание файла с зависимостями

Для того, чтобы потом вам легко было установить все необходимые библиотеки, лучше заранее подготовить файл с их полным списком. 

Составить такой файл можно легко командой
				`pip freeze > req.text`


Поменяйте версию джанго на 4. Так как новые версии джанго пока что не поддерживаются провайдером.

![фвыа](http://images.na4u.ru/static/deploy/2.png)

![фвыа](http://images.na4u.ru/static/deploy/3.png)

### Настройка приложения

- В настройках приложения измените значение переменной ALLOWED_HOSTS. Звездочка обозначает, что джанго будет обрабатывать запросы по любому доменному адресу. Потом можно сделать так, чтобы запросы принимались только от доменного имени вашего сайта. 

![фвыа](http://images.na4u.ru/static/deploy/4.png)
## 3. Cоздайние контейнера на сайте провайдера

Создание контейнера для деплоя описано в  туториале  [по деплою телегам бота](https://pythontop.streamlit.app/%D0%94%D0%B5%D0%BF%D0%BB%D0%BE%D0%B9_%D1%82%D0%B5%D0%BB%D0%B5%D0%B3%D1%80%D0%B0%D0%BC_%D0%B1%D0%BE%D1%82%D0%B0)
Пройдите его до шага "Загрузка файлов на сервер": 
- зарегистрируйтесь на сайте провайдера
- создайте контейнер для сайта 
- создайте сайт

При создании сайта лучше выбрать PostgreSQL в качестве базы данных. Чтобы потом можно было легко перейти на нее.


![фвыа](http://images.na4u.ru/static/deploy/5.png)

## 4. Загрузка файлов на сервер

К этому этапу вас должен быть созданный сайт в контейнере для сайтов: 

Так как джанго состоит из нескольких файлов, необходимо будет воспользоваться клиентов для передачи данных. 

### 1. Установка Filezilla

1. Зайдите на сайт https://filezilla.ru/get/ и установите FTP клиент filezilla
2. Запустите программу

![фвыа](http://images.na4u.ru/static/deploy/6.png)

![фвыа](http://images.na4u.ru/static/deploy/7.png)
### 2. Получение логина и пароля

1. Логин для подключения находится в настройке контейнера сайта
2. Хост тоже там 
3. Через опцию изменения пароля, получите новый пароль 

![фвыа](http://images.na4u.ru/static/deploy/8.png)

![фвыа](http://images.na4u.ru/static/deploy/9.png)

![фвыа](http://images.na4u.ru/static/deploy/11.png)

![фвыа](http://images.na4u.ru/static/deploy/12.png)

![фвыа](http://images.na4u.ru/static/deploy/13.png)



### 3. Подключение

Введите хост, логин и пароль в строке подключения. Кликните "ОК" во всплывающих окнах. Должно появиться окно с содержимым сайта. 

![фвыа](http://images.na4u.ru/static/deploy/14.png)

![фвыа](http://images.na4u.ru/static/deploy/15.png)
### 3. Передача файлов

1. Откройте папку app в окне Filezilla
2. Выделите файлы проекта для передачи на компьютере, перетащите в папку app внутри filezilla

![фвыа](http://images.na4u.ru/static/deploy/15_1.png)
![фвыа](http://images.na4u.ru/static/deploy/16.png)

![фвыа](http://images.na4u.ru/static/deploy/17.png)
## 5. Настройка окружения сервера

1. Перейдите в папку app с помощью команды 

```bash 
cd app
```


2. Установите библиотеки с помощью команды 
```bash 
pip install -r req.txt
```


3. Проверьте работу сервера

![фвыа](http://images.na4u.ru/static/deploy/18.png)

![фвыа](http://images.na4u.ru/static/deploy/19.png)

5. Зайдите в папку app и удалите оригинальный wsgi файл командой rm wsgi.py
6. Создайте новый ярлык для  файла wsgi.py создав ссылку на оригинальный файл wsgi.py

![фвыа](http://images.na4u.ru/static/deploy/20.png)

## 6. Проверка работы сайта 

![фвыа](http://images.na4u.ru/static/deploy/21.png)
## 7. Отображение статических файлов

Можно заметить, что пока сайт не видит наши стили. Это происходит потому, что провайдер настроил сервер нжинкс так, чтобы он искал статичные файлы внутри папки www/static. 

Это делается для того, чтобы файлы грузились быстрее, в обход джанго сервера. 
У джанги есть специальные настройки, который позволяют собирать статичный файлы внутри нужных папок. 

В настройках создайте переменную STATIC_ROOT где укажите полный путь до папки www вашего сайта


![фвыа](http://images.na4u.ru/static/deploy/22.png)

Обновите настройки, передав этот файл на сервер

Выполните команду 
```bash
python manage.py collectstatic
```

![фвыа](http://images.na4u.ru/static/deploy/23.png)

Проверьте, что стили подргрузились

![фвыа](http://images.na4u.ru/static/deploy/24.png)
## 8. Отключение дебага

В продакшене лучше ставить параметр Debug в  положение False, чтобы пользователи сайта не видели ничего лишнего

![фвыа](http://images.na4u.ru/static/deploy/25.png)