
## Django Forms. Валидация данных

В предыдущем разделе мы реализовали форму добавления новых книг. 
Давайте теперь отдельно погорим про валидацию.

Если мы попытаемся добавить книгу с пустым названием - получим сообщение об ошибке, форма не отправиться. Но кто генерирует эту ошибку? 

Если посмотреть на исходный html код увидим ограничения у инпутов. То есть эту ошибку генерирует фронтенд. 

Но что, если мы хотим добавить ограничение другого вида. Например, мы не хотим, чтобы в базу добавлялись книги с одним и тем же именем. 

Джанго формс позволяют делать это. Более того - они позволяют выводит корректные сообщения об ошибках. 


### Добавление проверки на уникальность

Для того, чтобы добавить новую валидацию к полю, надо следовать такому алгоритму: 
1. Создать метод с названием вида clean_<название поля>
2. Внутри него получить данные поля
3. Написать условие для выдачи ошибки. Ошибку вернуть с помощью оператора raise ValidationError("Текст ошибки")
4. Обязательно в конце метода вернуть исходные данные 

![фвыа](http://images.na4u.ru/static/django7/1.png)
```python
from django import forms 

from .models import Category, Book

class BookForm(forms.Form):
    title = forms.CharField(max_length=255, label='название книги')
    author = forms.CharField(max_length=255, label='автор книги')
    price = forms.IntegerField(label='цена книги')
    category = forms.ModelChoiceField(label='категория книги', queryset=Category.objects.all())


    def clean_title(self):
        title = self.cleaned_data['title']

        if Book.objects.filter(title=title).exists():
            raise forms.ValidationError('Такая книга уже есть')
        return title
```

Попробуйте добавить книгу, название которой уже есть в базе 

![фвыа](http://images.na4u.ru/static/django7/2.png)

Должные получить ошибку 

![фвыа](http://images.na4u.ru/static/django7/3.png)
Но как ошибка смогла появиться здесь. И как данные в форме не потерялись? Ведь страница перезагрузилась? 

Дело в том, что метод form.is_valid() вставляет в объект с формой информацию о найденных ошибках.  Ранее введенные данные уже и так содержатся в объекте с формой, так как вы передали их в самом начале. 
  
Если метод is_valid() возвращает False вы возвращаете шаблон с формой. Она может быть либо пустой, либо содержать данные и ошибки. Джанга просто отрисовывает форму согласно тем данным, которые у нее есть. 

![фвыа](http://images.na4u.ru/static/django7/4.png)

