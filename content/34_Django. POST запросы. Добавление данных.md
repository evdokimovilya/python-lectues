## Django. POST запросы. Добавление данных

Прежде чем читать эту лекцию, ознакомьтесь[ с лекцией про POST запросы](https://pythontop.streamlit.app/%D0%92%D0%B5%D0%B1._POST_%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D1%8B). 

В прошлой лекции мы узнали, что такое GET запросы, как их использовать для фильтрации данных. 

Добавление, изменение данных - еще одна важная часть в работе любого веб приложения. 
Для этого обычно используются POST запросы.

Рассмотрим пример с добавлением новой книги на сайт. 
### Создание формы для добавления книги 

Для того, чтобы реализовать функцию добавления книги - нам нужен соответствующий интерфейс -- то, куда можно будет вписывать данные и сохранять. 

В HTML для этого используются формы с тегом form. В них можно описать поля, названия полей, адрес, по которому данные будут отправляться на сервер. 

Создадим форму. 

### Вывод формы 

Создадим новую страницу для вывода формы. 

1. Добавьте новую функцию в файл view.py
2. В urls соедините новый адрес и название функции 

Перейдите в браузере по адресу, который вы указали в urls.py
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Страница книг</title>
</head>
<body>

<h1>Категории</h1>
{% for category in categories %}
<a href="?category_id={{category.id}}">{{category.title}}</a>
{% endfor %}

<h1>Список книг</h1>

{% for book in books %}
<p>{{book.title}} - {{book.author}} - {{book.price}} - {{book.category.title}}</p>
{% endfor %}

</body>
</html>
```


![фвыа](http://images.na4u.ru/static/django5/2_1.png)

```python
def add_book(request):
    return render(request, 'add_book.html')
```
![фвыа](http://images.na4u.ru/static/django5/2_2.png)

```python
from django.urls import path

from .views import hello, books, add_book


urlpatterns = [
    path('', hello),
    path('books', books),
    path('books/add', add_book)
]

```
![фвыа](http://images.na4u.ru/static/django5/3.png)

![фвыа](http://images.na4u.ru/static/django5/4.png)
### Вывод данных запроса

![фвыа](http://images.na4u.ru/static/django5/5.png)

Что произойдет после клика на кнопку "Добавить"? Должен отправить POST запрос на сервер. Обратите внимание, чтобы внутри тега forms стоял **method=post**.

Проверить, действительно ли запрос отправляется, можно через обычный print. Джанга использует объект request.POST, в котором хранит данные, если на сервер приходит POST запрос. Добавьте print. 

![фвыа](http://images.na4u.ru/static/django5/6.png)

Заполните форму, нажмите Добавите, посмотрите вывод в консоли. 
Объект request.POST похож на словарь. В качестве ключей у него названия полей, которые соответствуют атрибутам name в полях формы. 

![фвыа](http://images.na4u.ru/static/django5/7.png)


### Сохранение данных

Алгоритм:
1. Проверить, тип запроса. Если он POST - начинаем обработку.
2. По очереди получить данные каждого поля, обратившись к объекту запроса. 
3. Создать новый объект Book передав туда значения
4. Перенаправить пользователя на страницу со списком книг.

```python
def add_book(request):

    print(request.POST)
    if request.method == 'POST':
        title = request.POST.get('title')
        author = request.POST.get('author')
        price = request.POST.get('price')

        Book.objects.create(
            title=title,
            author=author,
            price=price
        )
        return redirect('/books')

    return render(request, 'add_book.html')
```


![фвыа](http://images.na4u.ru/static/django5/8.png)


![фвыа](http://images.na4u.ru/static/django5/9.png)
## Добавление поля "Категория"

### Вывод категорий

Для того, чтобы у нас появилась возможность добавлять категорию - надо вывести список категорий в специальном html виджете **select**. Для этого надо иметь список категорий в шаблоне. 

1. Передаем список категорий в шаблон, добавляя их в контекст
	![фвыа](http://images.na4u.ru/static/django5/10.png)
2. Выводим список категорий в шаблоне, используя шаблонный тэг для итерирования по элементам. 
3. Оставляем возможность не выбирать категорию 
![фвыа](http://images.na4u.ru/static/django5/11.png)

### Обработка категории в представлении

Так как категория - это поле, которое представляет собой объект другой таблица, для начала необходимо получить ее объект из базы. 

![фвыа](http://images.na4u.ru/static/django5/12.png)


![фвыа](http://images.na4u.ru/static/django5/13.png)

После этого мы можем добавить новое поле в место, где мы создаем новый объект Book
Проверьте, что категория добавилась 

![фвыа](http://images.na4u.ru/static/django5/14.png)
### Простая валидация

Давайте реализуем простую валидацию данных. Если пользователь не ввел какое-то поле, мы должны вывести ему ошибку.

Для этого изменим логику обработки данных. Теперь создавать новый объект будем только в том случае, если поля не содержат пустых значений. 



В противном случае, мы записываем в переменную errors сообщение об ошибке. Предварительно мы присвоили переменной errors пустое значение. 

Также переменную errors мы передаем в контекст, чтобы дальше выводит ее значение. 

![фвыа](http://images.na4u.ru/static/django5/15.png)

В шаблоне выведите значение переменной errors. 

![фвыа](http://images.na4u.ru/static/django5/16.png)

Проверьте, что теперь при пустом значении появляется ошибка

![фвыа](http://images.na4u.ru/static/django5/18.png)
# Визуализация

[В виде диаграммы](https://excalidraw.com/#json=neCQzBZ1Z1uBuSIDMV2oA,ojNLNMPakz-x7hEVKK9Gmg)



Или в виде картинки
![фвыа](http://images.na4u.ru/static/django5/19.png)